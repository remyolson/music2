<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Health Test</title>
  <style>
    body {
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: monospace;
      padding: 20px;
    }
    #results {
      white-space: pre-wrap;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 5px;
      margin-top: 20px;
    }
    button {
      background: #00ff88;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h1>Audio Health Test</h1>
  <p>This test will play a short musical sequence and monitor the audio health.</p>
  <button id="runTest">Run Audio Health Test</button>
  <div id="results"></div>

  <script type="module">
    import * as Tone from './node_modules/tone/build/esm/index.js';
    import { audioHealthMonitor } from './src/audioHealthMonitor.js';
    
    const resultsDiv = document.getElementById('results');
    
    document.getElementById('runTest').addEventListener('click', async () => {
      resultsDiv.textContent = 'Starting test...\n';
      
      // Start Tone.js
      await Tone.start();
      
      // Create test setup similar to audioEngine
      const masterGain = new Tone.Gain(0.2);
      const masterCompressor = new Tone.Compressor({
        threshold: -12,
        ratio: 4,
        attack: 0.003,
        release: 0.25
      });
      const masterHighpass = new Tone.Filter({
        type: "highpass",
        frequency: 20,
        rolloff: -24
      });
      const masterLimiter = new Tone.Limiter(-6);
      
      masterGain.chain(masterCompressor, masterHighpass, masterLimiter, Tone.Destination);
      
      // Create test instruments
      const synth1 = new Tone.PolySynth(Tone.Synth);
      const synth2 = new Tone.PolySynth(Tone.FMSynth);
      
      // Add instrument gain reduction
      const gain1 = new Tone.Gain(0.5);
      const gain2 = new Tone.Gain(0.5);
      
      synth1.chain(gain1, masterGain);
      synth2.chain(gain2, masterGain);
      
      // Initialize and start health monitoring
      audioHealthMonitor.initialize();
      audioHealthMonitor.startMonitoring();
      
      // Play test sequence
      const notes1 = ['C4', 'E4', 'G4', 'C5'];
      const notes2 = ['C3', 'G3', 'C3', 'G3'];
      
      resultsDiv.textContent += 'Playing test sequence...\n';
      
      // Schedule notes
      const now = Tone.now();
      notes1.forEach((note, i) => {
        synth1.triggerAttackRelease(note, '8n', now + i * 0.25);
      });
      notes2.forEach((note, i) => {
        synth2.triggerAttackRelease(note, '4n', now + i * 0.5);
      });
      
      // Monitor for 3 seconds
      let updateCount = 0;
      const interval = setInterval(() => {
        const report = audioHealthMonitor.getHealthReport();
        
        resultsDiv.textContent = `
Test Results (Update ${++updateCount}):
==================

Current Level: ${report.currentLevel.toFixed(2)} dB
Peak Level: ${report.peakLevel.toFixed(2)} dB
Average Level: ${report.averageLevel.toFixed(2)} dB

DC Offset: ${report.dcOffset.toFixed(4)}
Clipping Events: ${report.clippingCount}
Total Samples: ${report.totalSamples}

Health Status: ${report.isHealthy ? '✓ HEALTHY' : '✗ UNHEALTHY'}
Issues: ${report.issues.length > 0 ? report.issues.join(', ') : 'None'}

Audio Chain:
- Instrument Gain: 0.5 (50%)
- Master Gain: 0.2 (20%)
- Compressor: -12dB threshold, 4:1 ratio
- Highpass Filter: 20Hz (DC blocking)
- Limiter: -6dB ceiling
        `;
        
        if (updateCount >= 12) { // 3 seconds
          clearInterval(interval);
          audioHealthMonitor.stopMonitoring();
          
          resultsDiv.textContent += '\n\nTest completed!';
          
          // Cleanup
          synth1.dispose();
          synth2.dispose();
          gain1.dispose();
          gain2.dispose();
          masterGain.dispose();
          masterCompressor.dispose();
          masterHighpass.dispose();
          masterLimiter.dispose();
        }
      }, 250);
    });
  </script>
</body>
</html>